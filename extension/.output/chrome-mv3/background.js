var background=(function(){"use strict";function c(e){return e==null||typeof e=="function"?{main:e}:e}let r=null,a=!1,n=null;function d(e){if(!e)return null;const t=e.match(/(?:v=|\/embed\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return t?t[1]:null}function o(e){chrome.storage.session.set({commentatorState:e})}async function l(){(await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]})).length>0||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["USER_MEDIA"],justification:"Capture tab video frames for AI sports commentary"})}async function f(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id){o({active:!1,status:"No active tab found",tabId:null,videoId:null});return}r=e.id,n=d(e.url);try{const t=await chrome.tabCapture.getMediaStreamId({targetTabId:e.id});await l(),a=!0,o({active:!0,status:"Starting capture...",tabId:e.id,videoId:n}),n&&chrome.tabs.sendMessage(e.id,{type:"MUTE_TAB_VIDEO"}).catch(()=>{}),chrome.runtime.sendMessage({type:"CAPTURE_STARTED",streamId:t,tabId:e.id})}catch(t){const s=t instanceof Error?t.message:"Unknown error";o({active:!1,status:`Capture failed: ${s}`,tabId:null,videoId:null}),a=!1,r=null,n=null}}async function m(){r&&n&&chrome.tabs.sendMessage(r,{type:"UNMUTE_TAB_VIDEO"}).catch(()=>{}),a=!1,r=null,n=null,chrome.runtime.sendMessage({type:"STOP_CAPTURE"}),o({active:!1,status:"Stopped",tabId:null,videoId:null})}chrome.runtime.onMessage.addListener((e,t,s)=>{if(e.type==="START_CAPTURE")return f().then(()=>s({ok:!0})),!0;if(e.type==="STOP_CAPTURE")return m().then(()=>s({ok:!0})),!0;e.type==="STATUS"&&o({active:a,status:e.message,tabId:r,videoId:n})});const h=c(()=>{console.log("[AI Commentator] Service worker started"),chrome.action.onClicked.addListener(e=>{e.windowId&&chrome.sidePanel.open({windowId:e.windowId})})});function p(){}globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function i(e,...t){}const b={debug:(...e)=>i(console.debug,...e),log:(...e)=>i(console.log,...e),warn:(...e)=>i(console.warn,...e),error:(...e)=>i(console.error,...e)};let u;try{u=h.main(),u instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw b.error("The background crashed on startup!"),e}var g=u;return g})();
