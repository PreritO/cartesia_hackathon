import"./_virtual_wxt-html-plugins-DPbbfBKe.js";const S="ws://localhost:8000/ws/live",f=5,g=.7,u=1280;let d=null,e=null,l=null;const a=document.getElementById("captureVideo"),c=document.getElementById("captureCanvas"),p=c.getContext("2d");function i(t){chrome.runtime.sendMessage({type:"STATUS",message:t})}async function h(t){try{d=await navigator.mediaDevices.getUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:t}}}),a.srcObject=d,await a.play(),await new Promise(o=>{if(a.videoWidth>0){o();return}a.onloadedmetadata=()=>o()});let n=a.videoWidth,s=a.videoHeight;if(n>u){const o=u/n;n=u,s=Math.round(s*o)}c.width=n,c.height=s,i("Connecting to backend..."),e=new WebSocket(S),e.onopen=()=>{i("Connected to backend"),y()},e.onmessage=o=>{const r=JSON.parse(o.data);r.type==="status"?i(r.message):r.type==="commentary"&&chrome.runtime.sendMessage({type:"COMMENTARY",text:r.text,emotion:r.emotion,audio:r.audio})},e.onerror=()=>{i("WebSocket error â€” is the backend running?")},e.onclose=()=>{i("Disconnected from backend"),m()}}catch(n){const s=n instanceof Error?n.message:"Unknown error";i(`Capture error: ${s}`)}}function y(){const t=1e3/f;l=setInterval(()=>{!e||e.readyState!==WebSocket.OPEN||a.readyState<a.HAVE_CURRENT_DATA||(p.drawImage(a,0,0,c.width,c.height),c.toBlob(n=>{n&&e&&e.readyState===WebSocket.OPEN&&e.send(n)},"image/jpeg",g))},t)}function m(){l&&(clearInterval(l),l=null),e&&e.readyState===WebSocket.OPEN&&(e.send(JSON.stringify({type:"stop"})),e.close()),e=null,d&&(d.getTracks().forEach(t=>t.stop()),d=null),a.srcObject=null}chrome.runtime.onMessage.addListener(t=>{t.type==="CAPTURE_STARTED"&&h(t.streamId),t.type==="STOP_CAPTURE"&&m()});
