import{M as l,B as f,J as S,C as g}from"./constants--o_fPaDx.js";let d=null,e=null,u=null;const n=document.getElementById("captureVideo"),s=document.getElementById("captureCanvas"),p=s.getContext("2d");function i(t){chrome.runtime.sendMessage({type:"STATUS",message:t})}async function h(t){try{d=await navigator.mediaDevices.getUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:t}}}),n.srcObject=d,await n.play(),await new Promise(r=>{if(n.videoWidth>0){r();return}n.onloadedmetadata=()=>r()});let a=n.videoWidth,c=n.videoHeight;if(a>l){const r=l/a;a=l,c=Math.round(c*r)}s.width=a,s.height=c,i("Connecting to backend..."),e=new WebSocket(f),e.onopen=()=>{i("Connected to backend"),y()},e.onmessage=r=>{const o=JSON.parse(r.data);o.type==="status"?i(o.message):o.type==="commentary"&&chrome.runtime.sendMessage({type:"COMMENTARY",text:o.text,emotion:o.emotion,audio:o.audio,annotated_frame:o.annotated_frame??null})},e.onerror=()=>{i("WebSocket error â€” is the backend running?")},e.onclose=()=>{i("Disconnected from backend"),m()}}catch(a){const c=a instanceof Error?a.message:"Unknown error";i(`Capture error: ${c}`)}}function y(){const t=1e3/g;u=setInterval(()=>{!e||e.readyState!==WebSocket.OPEN||n.readyState<n.HAVE_CURRENT_DATA||(p.drawImage(n,0,0,s.width,s.height),s.toBlob(a=>{a&&e&&e.readyState===WebSocket.OPEN&&e.send(a)},"image/jpeg",S))},t)}function m(){u&&(clearInterval(u),u=null),e&&e.readyState===WebSocket.OPEN&&(e.send(JSON.stringify({type:"stop"})),e.close()),e=null,d&&(d.getTracks().forEach(t=>t.stop()),d=null),n.srcObject=null}chrome.runtime.onMessage.addListener(t=>{t.type==="CAPTURE_STARTED"&&h(t.streamId),t.type==="STOP_CAPTURE"&&m()});
